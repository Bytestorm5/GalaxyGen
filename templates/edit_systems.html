<html>
    <head>
            

        <script type="text/javascript">
            var myImg;
            var rgba;
            var width;

            var edit_mode = 0;
            var selection_text;

            function FindPosition(oElement)
            {
                if(typeof( oElement.offsetParent ) != "undefined")
                {
                    for(var posX = 0, posY = 0; oElement; oElement = oElement.offsetParent)
                    {
                        posX += oElement.offsetLeft;
                        posY += oElement.offsetTop;
                    }
                    return [ posX, posY ];
                }
                else
                {
                    return [ oElement.x, oElement.y ];
                }
            }

            const getColorIndicesForCoord = (x, y, width) => {
                const red = y * (width * 4) + x * 4;
                return [red, red + 1, red + 2, red + 3];
            };


            async function GetCoordinates(e)
            {
                if (e.which != 1) {
                    return
                }
                var PosX = 0;
                var PosY = 0;
                var ImgPos;
                ImgPos = FindPosition(myImg);
                if (!e) var e = window.event;
                if (e.pageX || e.pageY)
                {
                    PosX = e.pageX;
                    PosY = e.pageY;
                }
                else if (e.clientX || e.clientY)
                {
                    PosX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                    PosY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
                }
                PosX = PosX - ImgPos[0];
                PosY = PosY - ImgPos[1];
                //document.getElementById("x").innerHTML = PosX;
                //document.getElementById("y").innerHTML = PosY;
                console.log(`X: ${PosX} | Y: ${PosY}`)
                position_text.innerHTML = `X: ${PosX} | Y: ${PosY}`
                //var [redIndex, greenIndex, blueIndex, alphaIndex] = getColorIndicesForCoord();
                //console.log(`R: ${rgba[redIndex]} | G: ${rgba[greenIndex]} | B: ${rgba[blueIndex]}`)
                selection_text.innerHTML = await get_mask(PosX, PosY)
                console.log(await get_mask(PosX, PosY))
            }
            
            async function get_mask(x, y) {
                var requestOptions = {
                    method: 'GET',
                    redirect: 'follow'
                };

                //var raw;
                
                return await fetch(`/api/getMask?x=${x}&y=${y}`, requestOptions)
                .then(response => response.text())
                .then(result => {
                    console.log(result)
                    var raw = JSON.parse(result)['pixel']
                    if (raw[0] != 0) {
                        var out = raw[0] == 255 ?"Star " : "Lane ";                    
                        var id = raw[1]
                        id += raw[2] * 255
                        out += `${id}`                        
                        return out
                    }     
                    else {
                        return "Background"
                    }
                })
                .catch(error => console.log('error', error));             
            }

            

            addEventListener('DOMContentLoaded', (event) => {
                myImg = document.getElementById("myImgId");
                myImg.onmousedown = GetCoordinates;

                position_text = document.getElementById("coord_viewer")
                selection_text = document.getElementById("selected_item")

                var link = document.getElementById('b_viewer');
                link.onclick = (event) => {
                    console.log("Viewer Mode")
                    edit_mode = 0;
                };

                link = document.getElementById('b_mod_star');
                link.onclick = (event) => {
                    console.log("Star Modifier")
                    edit_mode = 1;
                };

                link = document.getElementById('b_add_star');
                link.onclick = (event) => {
                    console.log("Add Star")
                    edit_mode = 2;
                };

                link = document.getElementById('b_del_lane');
                link.onclick = (event) => {
                    console.log("Delete Lane")
                    edit_mode = 3;
                };

                link = document.getElementById('b_add_lane');
                link.onclick = (event) => {
                    console.log("Add Lane")
                    edit_mode = 4;
                };
            });
        </script>
    </head>
    <style>
        #toolbar a {
            display: block;
            background-color: rgba(255, 255, 255, 0.5); 
            border: 2px solid gray;
            border-radius: 25px;
            margin: 7.5px;
        }
        #toolbar a:hover {
            background-color: rgba(255, 255, 255, 0.75); 
        }
        #toolbar a:active {
            background-color: rgba(255, 255, 255, 0.25); 
        }
    </style>
    <body>        
        <img id="myImgId" src="output.png" style="margin: 0 auto; z-index: 0;">
        <div>
            <div style="position: fixed; left: 1%; top: 1%; z-index: 3000; padding: 5px; border-radius: 5px; background-color: rgba(255, 255, 255, 0.5); border: 2px solid aqua">
                <p id="coord_viewer">X: 0, Y:0</p>
                <p id="selected_item">No Object Selected</p>
            </div>            
            <div id="toolbar" style="position: fixed; left: 1%; top: 25%; z-index: 3000;">
                <a id="b_viewer">
                    <img style="width: 64px;" src="images\eye_icon.png">
                </a>
                <a id="b_mod_star">
                    <img style="width: 64px;" src="images\select_star.png">
                </a>
                <a id="b_add_star">
                    <img style="width: 64px;" src="images\add_star.png">
                </a>
                <a id="b_del_lane">
                    <img style="width: 64px;" src="images\select_lane.png">
                </a>
                <a id="b_add_lane">
                    <img style="width: 64px;" src="images\add_lane.png">
                </a>
            </div>            
        </div>
    </body>
</html>